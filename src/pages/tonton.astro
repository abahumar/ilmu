---
import BaseLayout from '../layouts/BaseLayout.astro';
import { videos } from '../data/videos';
---

<BaseLayout title="Tonton | ilmu.my">
  <section id="watchArea" class="watch-layout"></section>
  <section>
    <div class="section-head">
      <h2>Cadangan Lain</h2>
    </div>
    <div id="relatedVideos" class="video-grid"></div>
    <div id="relatedLoadMoreWrap" class="load-more-wrap" style="display:none;">
      <button class="btn" id="relatedLoadMoreBtn" type="button">Muat lagi 8 video</button>
    </div>
  </section>

  <script id="videos-data" type="application/json" set:html={JSON.stringify(videos)}></script>
  <script type="module">
    const PAGE_SIZE = 8;
    const byRecent = (items) => [...items].reverse();
    const safeText = (value) => String(value ?? '').replace(/[<>]/g, '');
    const videoThumb = (videoId) => `https://i.ytimg.com/vi/${encodeURIComponent(videoId)}/hqdefault.jpg`;
    const THUMB_FALLBACK_SRC = '/thumb-fallback.svg';

    const videoCardHtml = (video) => `
      <article class="card">
        <a href="/tonton?v=${encodeURIComponent(video.id)}" aria-label="Tonton ${safeText(video.title)}">
          <img class="thumb" src="${videoThumb(video.id)}" alt="Thumbnail ${safeText(video.title)}" loading="lazy" onerror="this.onerror=null;this.src='${THUMB_FALLBACK_SRC}'" />
        </a>
        <div class="video-card-content">
          <h3 class="video-title"><a href="/tonton?v=${encodeURIComponent(video.id)}">${safeText(video.title)}</a></h3>
          <p class="meta">${safeText(video.channel)} â€¢ ${safeText(video.category)}</p>
        </div>
      </article>
    `;

    const videos = JSON.parse(document.getElementById('videos-data')?.textContent || '[]');
    const watchArea = document.getElementById('watchArea');
    const related = document.getElementById('relatedVideos');
    const relatedLoadMoreWrap = document.getElementById('relatedLoadMoreWrap');
    const relatedLoadMoreBtn = document.getElementById('relatedLoadMoreBtn');

    const videoId = new URLSearchParams(window.location.search).get('v');
    const video = videos.find((item) => item.id === videoId);

    let relatedVideos = [];
    let relatedOffset = 0;

    const renderRelatedBatch = () => {
      if (!related) {
        return;
      }

      const nextBatch = relatedVideos.slice(relatedOffset, relatedOffset + PAGE_SIZE);
      related.innerHTML += nextBatch.map(videoCardHtml).join('');
      relatedOffset += nextBatch.length;

      if (relatedLoadMoreWrap && relatedLoadMoreBtn) {
        const hasMore = relatedOffset < relatedVideos.length;
        relatedLoadMoreWrap.style.display = hasMore ? 'flex' : 'none';
      }
    };

    if (!video) {
      if (watchArea) {
        watchArea.innerHTML = '<p class="muted">Video tidak ditemui atau telah dikeluarkan daripada senarai.</p>';
      }

      relatedVideos = byRecent(videos);
    } else {
      if (watchArea) {
        watchArea.innerHTML = `
          <div class="player-wrap">
            <iframe
              src="https://www.youtube-nocookie.com/embed/${encodeURIComponent(video.id)}?rel=0"
              title="${safeText(video.title)}"
              loading="lazy"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen
            ></iframe>
          </div>
          <article class="watch-info">
            <h1>${safeText(video.title)}</h1>
            <p>${safeText(video.description)}</p>
            <p>
              Saluran asal:
              <a href="${safeText(video.channelUrl)}" target="_blank" rel="noopener noreferrer">${safeText(video.channel)}</a>
            </p>
            <p>
              <a href="/lapor">Lapor kandungan ini</a>
            </p>
          </article>
        `;
      }

      relatedVideos = byRecent(videos).filter((item) => item.id !== video.id);
    }

    if (related) {
      related.innerHTML = '';
      renderRelatedBatch();

      if (relatedLoadMoreBtn) {
        relatedLoadMoreBtn.addEventListener('click', renderRelatedBatch);
      }
    }
  </script>
</BaseLayout>