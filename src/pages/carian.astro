---
import BaseLayout from '../layouts/BaseLayout.astro';
import { videos } from '../data/videos';
import { videoCardHtml, byRecent } from '../utils/videos';

const allVideos = byRecent(videos);
---

<BaseLayout title="Carian | ilmu.my">
  <section class="section-head">
    <h1>Carian Video</h1>
  </section>
  <form id="searchForm" class="search-form">
    <input id="searchInput" type="search" placeholder="Cari tajuk, ustaz, atau topik..." required />
    <button class="btn" type="submit">Cari</button>
  </form>
  <div id="searchResultInfo" class="muted"></div>
  <div id="searchResults" class="video-grid">
    {allVideos.map((v) => <Fragment set:html={videoCardHtml(v)} />)}
  </div>

  <script id="videos-data" type="application/json" set:html={JSON.stringify(videos)}></script>
  <script type="module">
    const safeText = (value) => String(value ?? '').replace(/[<>]/g, '');
    const videoThumb = (videoId) => `https://i.ytimg.com/vi/${encodeURIComponent(videoId)}/hqdefault.jpg`;
    const videoCardHtml = (video) => `
      <article class="card">
        <a href="/tonton?v=${encodeURIComponent(video.id)}" aria-label="Tonton ${safeText(video.title)}">
          <img class="thumb" src="${videoThumb(video.id)}" alt="Thumbnail ${safeText(video.title)}" loading="lazy" onerror="this.onerror=null;this.src='/thumb-fallback.svg'" />
        </a>
        <div class="video-card-content">
          <h3 class="video-title"><a href="/tonton?v=${encodeURIComponent(video.id)}">${safeText(video.title)}</a></h3>
          <p class="meta">${safeText(video.channel)} â€¢ ${safeText(video.category)}</p>
        </div>
      </article>
    `;

    const videos = JSON.parse(document.getElementById('videos-data')?.textContent || '[]');
    const form = document.getElementById('searchForm');
    const input = document.getElementById('searchInput');
    const target = document.getElementById('searchResults');
    const info = document.getElementById('searchResultInfo');

    const getQueryParam = (name) => new URLSearchParams(window.location.search).get(name);
    const defaultHtml = target?.innerHTML || '';
    const runSearch = (query) => {
      const trimmed = query.trim().toLowerCase();
      if (!trimmed) {
        target.innerHTML = defaultHtml;
        info.textContent = '';
        return;
      }

      const results = videos.filter((video) => {
        const bag = [video.title, video.channel, video.category, ...(video.tags || [])].join(' ').toLowerCase();
        return bag.includes(trimmed);
      });

      info.textContent = `${results.length} hasil ditemui untuk "${query}"`;
      target.innerHTML = results.length
        ? results.map(videoCardHtml).join('')
        : '<p class="muted">Tiada hasil carian. Cuba kata kunci lain.</p>';
    };

    form?.addEventListener('submit', (event) => {
      event.preventDefault();
      runSearch(input?.value || '');
      const params = new URLSearchParams(window.location.search);
      params.set('q', input?.value || '');
      window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);
    });

    const initialQuery = getQueryParam('q') || '';
    if (input && initialQuery) {
      input.value = initialQuery;
      runSearch(initialQuery);
    }
  </script>
</BaseLayout>